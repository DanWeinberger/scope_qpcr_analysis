---
title: "Statistical Analysis Plan for SCOPE"
author: "Dan Weinberger"
date: '2022-09-22'
output:
  word_document: default
  html_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
options(dplyr.summarise.inform = FALSE)
library(ggplot2)
library(ggalluvial)
library(kableExtra)
library(knitr)
library(reshape2)
library(flextable)
library(msm)
```

## Overview

The SCOPE study enrolled adults 60 years of age and older in greater New Haven over the course of 2 years (October 2020-September 2022). Individuals were followed longitudinally over a 10 week period (6 visits, 2 weeks apart). At each study visit, individuals provided a saliva sample, and at the final visit, they provided a urine sample. They also completed a questionnaire about their activities and contacts with others. A unique aspect of this study is that subjects were enrolled as pairs living in the same household, and these two people were the only members of the household.

## Study objectives

The goals of the study are to quantify the acquisition and clearance rates of pneumococcus among older adults living in a community setting, to identify risk factors for colonization, and to quantify within-household transmission of pneumococcus.

## Laboratory methods

In the laboratory, saliva was culture enriched and tested for *lytA* and *piaB with qPCR.* A Ct value of \<40 was considered to be positive. Because piaB is a highly specific marker for pneumococcus and because piaB was more sensitive than the lytA assay at low concentration, we considered those who were positive for piaB to be positive for pneumococcus. To reduce the possibility of false positivity, any samples in the range of 35-40 Ct were retested to confirm the positive. In the case of discrepant results, they were tested a 3rd time as a tie breaker.

## Analysis plan

### Descriptive statistics

```{r}
pcr_summary_long <- readRDS('./Data/PCR_compiled.rds')

pcr_survey <- readRDS('./Data./pcr_survey_combined.rds') %>%
  mutate(Gender = if_else(Gender %in% c('F','Female'),'F',Gender),
         Gender = if_else(Gender %in% c('M','Male'),'M',Gender),
         child_contact_often= if_else(is.na(child_contact_often),999,child_contact_often)) %>%
  filter(piab != 9999) %>%
  mutate(piab_pos = if_else(piab < 40,1,0),
         lyta_pos = if_else(lyta < 40,1,0), 
         season=substr(ID,1,2),
          Gender=if_else(ID=='S2_77' & is.na(Gender), 'F',Gender))
```

-   lytA vs piaB Ct values

```{r}

p1 <- ggplot(pcr_summary_long,aes(x=lyta, y=piab, alpha=0.5))+
  theme_classic() +
  geom_point() +
  ylim(45,10) +
  xlim(45,10)+ 
  xlab('lytA') +
  ylab('piaB') +
  theme(legend.position = "none") +
  geom_abline(col='gray', lty=2) +
  geom_hline(yintercept=40,col='gray', lty=3)+
  geom_vline(xintercept=40,col='gray', lty=3)

p1

```

-   Percent of tests that were positive, overall

```{r}

t1 <- pcr_summary_long %>%
  filter(piab != 9999) %>%
  mutate(piab_pos = if_else(piab < 40,1,0),
         lyta_pos = if_else(lyta < 40,1,0)) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), `Percent piab`=round(mean(piab_pos)*100,2) )

flextable(t1)
```

      - and by year

```{r}

t2 <- pcr_summary_long %>%
  filter(piab != 9999) %>%
  mutate(piab_pos = if_else(piab < 40,1,0),
         lyta_pos = if_else(lyta < 40,1,0), season=substr(ID,1,2)) %>%
  group_by(season) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )

flextable(t2)
```

-   Percent of people who were positive (period prevalence)

```{r}
t3 <- pcr_summary_long %>%
  filter(piab != 9999) %>%
  mutate(piab_pos = if_else(piab < 40,1,0),
         lyta_pos = if_else(lyta < 40,1,0),
         season=substr(ID,1,2) ) %>%
  group_by(ID,season) %>%
  summarize(any_pos_piab = max(piab_pos)) %>%
  ungroup() %>%
  group_by(season) %>%
  summarize(N_people=n(), N_pos=sum(any_pos_piab), `Percent Positive People`=round(100*mean(any_pos_piab),1))

flextable(t3)
```

-   Percent of households that were positive

```{r}
t4 <-     pcr_summary_long %>%
      filter(piab != 9999) %>%
      mutate(piab_pos = if_else(piab < 40,1,0),
             lyta_pos = if_else(lyta < 40,1,0),
             season=substr(ID,1,2) ) %>%
      group_by(Household,season) %>%
      summarize(any_pos_piab = max(piab_pos)) %>%
      ungroup() %>%
      group_by(season) %>%
      summarize(N_households=n(), N_pos=sum(any_pos_piab), `Percent Positive HH`=round(100*mean(any_pos_piab),1))
    
flextable(t4)    
```

-   Percent positive and average Ct, by sex

```{r}
t5 <- pcr_survey %>%
  group_by(Gender,season) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )

t5 <- as_grouped_data(x = t5, groups = c("Gender"), columns = NULL)

flextable(t5) 
```
-   Percent positive by symptoms

```{r}
t5 <- pcr_survey %>%
  group_by(recent_nasal) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) ) %>%
  mutate( recent_nasal = if_else(is.na(recent_nasal), 'Missing',recent_nasal) )

t5 <- as_grouped_data(x = t5, groups = c("recent_nasal"), columns = NULL)

flextable(t5) 
```

```{r}
t5 <- pcr_survey %>%
  group_by(recent_runny_nose) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )%>%
  mutate( recent_runny_nose = if_else(is.na(recent_runny_nose), 'Missing',recent_runny_nose) )

t5 <- as_grouped_data(x = t5, groups = c("recent_runny_nose"), columns = NULL)

flextable(t5) 
```

Recent Abx

```{r}
t5 <- pcr_survey %>%
  group_by(recent_abx) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )%>%
  mutate( recent_abx = if_else(is.na(recent_abx), 'Missing',recent_abx) )

t5 <- as_grouped_data(x = t5, groups = c("recent_abx"), columns = NULL)

flextable(t5) 
```
an analysis of positivity by vax status? PPV status? PCV status? PPV/PCV status? Flu+PPV/PCV?

```{r}
t5 <- pcr_survey %>%
  mutate(recent_pneumo_vax =as.character(recent_pneumo_vax )) %>%
  group_by(recent_pneumo_vax) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )%>%
  mutate( recent_pneumo_vax = if_else(is.na(recent_pneumo_vax), 'Missing',recent_pneumo_vax) )

t5 <- as_grouped_data(x = t5, groups = c("recent_pneumo_vax"), columns = NULL)

flextable(t5)
```

```{r}
t5 <- pcr_survey %>%
  mutate(recent_flu_vax =as.character(recent_flu_vax )) %>%
  group_by(recent_flu_vax) %>%
  summarize(N_piaB= sum(piab_pos), N_test= n(), Pct_piab=round(mean(piab_pos)*100,1) )%>%
  mutate( recent_flu_vax = if_else(is.na(recent_flu_vax), 'Missing',recent_flu_vax) )

t5 <- as_grouped_data(x = t5, groups = c("recent_flu_vax"), columns = NULL)

flextable(t5)
```




-   Percent positive by calendar month

-   Percent of individuals with contacts, by age of contacts

## Activities by year

    Activity with family?

```{r}
t6 <- pcr_survey %>%
  filter(activity_family!=9999) %>%
  group_by( Gender, season) %>%
  summarize(N_Activity_family=sum(activity_family, na.rm=T), N=n(), Pct=round(100*mean(activity_family, na.rm=T),2))

t6 <- as_grouped_data(x = t6, groups = c("Gender"), columns = NULL)

flextable(t6) # 
```

contact <5 years 

```{r}
t7 <-pcr_survey %>%
  filter(child_contact_u12m!=9999) %>%
  group_by( Gender,season) %>%
  mutate(child_contact_u5 = if_else( (child_contact_u12m==1 |child_contact_13_23m==1 | child_contact_24_59m==1),1,0   )) %>%
  summarize(N_contact_u5=sum(child_contact_u5, na.rm=T), N=n(), Pct=round(100*mean(child_contact_u5, na.rm=T),2))

t7 <- as_grouped_data(x = t7, groups = c("Gender"), columns = NULL)

flextable(t7)
```

Child contact <12 m 

```{r}
t8 <- pcr_survey %>%
  filter(child_contact_u12m!=9999) %>%
  group_by( Gender,season) %>%
    summarize(N_contact_u12m=sum(child_contact_u12m, na.rm=T), N=n(), Pct=round(100*mean(child_contact_u12m, na.rm=T),1))

t8 <- as_grouped_data(x = t8, groups = c("Gender"), columns = NULL)

flextable(t8)
```
Child contact 12-23m

```{r}
t9 <- pcr_survey %>%
  filter(child_contact_13_23m!=9999) %>%
  group_by(Gender,season) %>%
    summarize(N_contact_12_23m=sum(child_contact_13_23m, na.rm=T), N=n(), Pct=round(100*mean(child_contact_13_23m, na.rm=T),2))

t9 <- as_grouped_data(x = t9, groups = c("Gender"), columns = NULL)

flextable(t9)
```

Child contact 24-59 m

```{r}
t10 <- pcr_survey %>%
  filter(child_contact_24_59m!=9999) %>%
  group_by( Gender, season) %>%
    summarize(N_contact_24_59m=sum(child_contact_24_59m, na.rm=T), N=n(), Pct=round(100*mean(child_contact_24_59m, na.rm=T),2))

t10 <- as_grouped_data(x = t10, groups = c("Gender"), columns = NULL)

flextable(t10)
```

Child contact 5-9y
```{r}
t11 <- pcr_survey %>%
  filter(child_contact_5_10y!=9999) %>%
  group_by(Gender, season) %>%
    summarize(N_contact_5_9y=sum(child_contact_5_10y, na.rm=T), N=n(), Pct=round(100*mean(child_contact_5_10y, na.rm=T),2))

t11 <- as_grouped_data(x = t11, groups = c("Gender"), columns = NULL)

flextable(t11)
```

Child contact >10y

```{r}
t12 <- pcr_survey %>%
  filter(child_contact_over10y!=9999) %>%
  group_by( Gender,season) %>%
    summarize(N_contact_10y_older=sum(child_contact_over10y, na.rm=T), N=n(), Pct=round(100*mean(child_contact_over10y, na.rm=T),2))


t12 <- as_grouped_data(x = t12, groups = c("Gender"), columns = NULL)

flextable(t12)
```

How does intensity of child contact vary by season

0= none reported, 1=Daily; 2=every few days; 3= once or twice a month
```{r}
t13 <-  pcr_survey %>%
  filter(child_contact != 9999) %>% #must answer question...lots of missing surveys in S1
  mutate(child_contact_often = if_else(is.na(child_contact_often) |child_contact_often==999,0,child_contact_often) ) %>%
  group_by(Gender, season,child_contact_often ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

t13.t <- as_grouped_data(x = t13, groups = c("Gender", 'season'), columns = NULL)

flextable(t13.t) 

```

```{r, fig.width=4, fig.height=2}
d1 <- t13 %>%
  filter( child_contact_often !=999) %>%
  mutate(season= as.factor(season) , Gender=as.factor(Gender), child_contact_often=factor(child_contact_often,levels=c('0','1','2','3'), labels=c('None','Daily','Every few days','Few times/month') ))

d1.c <- dcast(d1, Gender + season ~child_contact_often ,value.var='Percent' )

d1.m <- melt(d1.c, id.vars=c('Gender','season')) %>%
  mutate(value= if_else(is.na(value),0, value))

ggplot(d1.m, aes(x=season, stratum=variable,alluvium=variable,fill=variable,label=variable, y = value)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray") +
  theme_classic()  +
  facet_wrap(~Gender)
```

Just among those who have contact with kids 1-10y
```{r}
t13a <-  pcr_survey %>%
  filter(child_contact_13_23m==1 | child_contact_24_59m==1 | child_contact_5_10y==1) %>% #must answer question...lots of missing surveys in S1
  mutate(child_contact_often = if_else(is.na(child_contact_often) |child_contact_often==999,0,child_contact_often) ) %>%
  group_by(Gender, season,child_contact_often ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

d1 <- t13a %>%
  mutate(season= as.factor(season) , Gender=as.factor(Gender), child_contact_often=factor(child_contact_often,levels=c('0','1','2','3'), labels=c('Missing','Daily','Every few days','Few times/month') ))

d1.c <- dcast(d1, Gender + season ~child_contact_often ,value.var='Percent' )

d1.m <- melt(d1.c, id.vars=c('Gender','season')) %>%
  mutate(value= if_else(is.na(value),0, value))

ggplot(d1.m, aes(x=season, stratum=variable,alluvium=variable,fill=variable,label=variable, y = value)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray") +
  theme_classic()  +
  facet_wrap(~Gender) + 
  ggtitle('Frequency of contacts with 1-10y')
```

Hours with kids?
1= < 4 hours (just a morning or afternoon or evening) 
2= 4-8 hours (full day) 
3= 8+ hours (longer visit such as day care or overnight)

```{r}
t14  <- pcr_survey %>%
 filter(child_contact != 9999) %>% #must answer question...lots of missing surveys in S1 %>%
    mutate(child_contact_hours = if_else(is.na(child_contact_hours) |child_contact_hours==999,0,child_contact_hours) ) %>%

  group_by(Gender, season,child_contact_hours ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2)) %>%
  ungroup()

t14.t <- as_grouped_data(x = t14, groups = c("Gender", 'season'), columns = NULL)

flextable(t14.t) 
```

```{r, fig.width=4, fig.height=2}
d1 <- t14 %>%
  filter(child_contact_hours !=999) %>%
  mutate(season= as.factor(season) , Gender=as.factor(Gender), child_contact_hours=factor(child_contact_hours,levels=c('0','1','2','3'), labels=c('None','<4h','4-8h','>8h') ))

d1.c <- dcast(d1, Gender + season ~child_contact_hours ,value.var='Percent' )

d1.m <- melt(d1.c, id.vars=c('Gender','season')) %>%
  mutate(value= if_else(is.na(value),0, value))

ggplot(d1.m, aes(x=season, stratum=variable,alluvium=variable,fill=variable,label=variable, y = value)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray") +
  theme_classic()  +
  facet_wrap(~Gender)
```

And just for kids with contact with 1-10 year olds
```{r}
t14a  <- pcr_survey %>%
 filter(child_contact_13_23m==1 | child_contact_24_59m==1 | child_contact_5_10y==1) %>% #must answer question...lots of missing surveys in S1 %>%
    mutate(child_contact_hours = if_else(is.na(child_contact_hours) |child_contact_hours==999,0,child_contact_hours) ) %>%

  group_by(Gender, season,child_contact_hours ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2)) %>%
  ungroup()

d1 <- t14a %>%
  filter(child_contact_hours !=999) %>%
  mutate(season= as.factor(season) , Gender=as.factor(Gender), child_contact_hours=factor(child_contact_hours,levels=c('0','1','2','3'), labels=c('Missing','<4h','4-8h','>8h') ))

d1.c <- dcast(d1, Gender + season ~child_contact_hours ,value.var='Percent' )

d1.m <- melt(d1.c, id.vars=c('Gender','season')) %>%
  mutate(value= if_else(is.na(value),0, value))

ggplot(d1.m, aes(x=season, stratum=variable,alluvium=variable,fill=variable,label=variable, y = value)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray") +
  theme_classic()  +
  facet_wrap(~Gender) +
  ggtitle('Intensity of contact ith kids 1-10y')

```
Recent runny nose?

```{r}
t13 <-  pcr_survey %>%
  mutate(recent_runny_nose = if_else(is.na(recent_runny_nose) ,'9999',recent_runny_nose) ) %>%
  group_by(Gender, season,recent_runny_nose ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

t13.t <- as_grouped_data(x = t13, groups = c("Gender", 'season'), columns = NULL)

flextable(t13.t) 

```

```{r}
t13 <-  pcr_survey %>%
  mutate(recent_nasal = if_else(is.na(recent_nasal) ,'9999',recent_nasal) ) %>%
  group_by(Gender, season,recent_nasal ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

t13.t <- as_grouped_data(x = t13, groups = c("Gender", 'season'), columns = NULL)

flextable(t13.t) 

```
Recent antibiotics? 

```{r}
t13 <-  pcr_survey %>%
  mutate(recent_abx = if_else(is.na(recent_abx) ,'9999',recent_abx) ) %>%
  group_by(Gender, season,recent_abx ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

t13.t <- as_grouped_data(x = t13, groups = c("Gender", 'season'), columns = NULL)

flextable(t13.t) 

```


The coding on this needs to be fixed.
```{r}
t13 <-  pcr_survey %>%
  mutate(recent_covid_vax = if_else(is.na(recent_covid_vax) ,9999,recent_covid_vax) ) %>%
  group_by(Gender, season,recent_covid_vax ) %>%
  summarize(N=n()) %>%
  ungroup() %>%
  group_by(Gender,season) %>%
  mutate(Percent= round(100*N/sum(N),2))

t13.t <- as_grouped_data(x = t13, groups = c("Gender", 'season'), columns = NULL)

flextable(t13.t) 

```


## Percent positive by different characteristics? 


Are both peoepl in the HH positive?
0= neither positive; 1= 1 person positive, 2=both positive


```{r}

t18 <- pcr_survey %>%
  group_by(time, Household, season) %>%
  summarize(N_pos_time=sum(piab_pos)) %>%
  ungroup() %>%
  group_by( season,N_pos_time) %>%
  summarize(N=n())

t18 <- as_grouped_data(x = t18, groups = c('season'), columns = NULL)

flextable(t18)
```

-   Proportion positive, stratified by contacts

    -   Contact with children \<5 years
    
Between seasons, among people without reported child contact, prevalence is much lower; it is similar among those with a reported contact

```{r}
t16  <- pcr_survey %>%
  mutate(child_contact_u5 = if_else( (child_contact_u12m==1 |child_contact_13_23m==1 | child_contact_24_59m==1),1,0   ),
         child_contact_u5= if_else(is.na(child_contact_u12m)| child_contact_u12m==9999,9999,child_contact_u5)) %>%
  group_by( child_contact_u5, season ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_u5"), columns = NULL)

flextable(t16) 
```
    

    -   Contact with children \<1 year, 1-2 years, 2-4 years, 5-9 years, 10 years and older
    
    <12m
```{r}
t16  <- pcr_survey %>%
  group_by( child_contact_u12m, season ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_u12m"), columns = NULL)

flextable(t16)
```

12-23m
```{r}
t16  <- pcr_survey %>%
  group_by( child_contact_13_23m ,season) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_13_23m"), columns = NULL)


flextable(t16)
```

```{r}
t16  <- pcr_survey %>%
  group_by( child_contact_24_59m ,season) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_24_59m"), columns = NULL)


flextable(t16)
```

```{r}
t16  <- pcr_survey %>%
  group_by( child_contact_5_10y,season ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_5_10y"), columns = NULL)


flextable(t16)
```

```{r}
t16  <- pcr_survey %>%
  group_by( child_contact_over10y , season) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("child_contact_over10y"), columns = NULL)


flextable(t16)
```

### intensity of contact

Seems to show people with less intense contact have higher prevalence. This seems counter-intuitive, until you look at the next 2 tables, which show that prevalence is higher in people with more frequent contact; and people with more frequent contact tend to have fewer contact hours per visit. This suggest frequency is the driver.

1, < 4 hours (just a morning or afternoon or evening) | 
2, 4-8 hours (full day) | 
3, 8+ hours (longer visit such as day care or overnight)

```{r}
t17  <- pcr_survey %>%
  mutate(child_contact_hours= if_else(is.na(child_contact_hours),999,child_contact_hours)) %>%
  group_by(  child_contact_hours ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

#t17 <- as_grouped_data(x = t17, groups = c("season"), columns = NULL)


flextable(t17)
```

frequency of contact vs pneumo positivity
1, Daily | 
2, Every few days | 
3, Once or twice a month
This makes sense--more common contatct, more carriage

N_pos is the number of positives for that level of contact frequency; pct_pos is percent positive for that level

```{r}
t17  <- pcr_survey %>%
  group_by( child_contact_often ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

flextable(t17)
```
What is relationship between frequency of child contact and intensity? Higher frequency; less intensity per visit

```{r}
tab1 <- pcr_survey %>%
  filter(child_contact_hours !=999 & child_contact_often !=999)

table(tab1$child_contact_hours)

table(tab1$child_contact_often)

table(tab1$child_contact_often, tab1$child_contact_hours)

```

Out of curiousity, break down the table of pneumo poisitivity by contact frequency AND gender. This is interesting; women who have daily contact have super high prevalence; men not so much. 

```{r}
t17  <- pcr_survey %>%
  group_by(Gender, child_contact_often ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t17 <- as_grouped_data(x = t17, groups = c("Gender"), columns = NULL)

flextable(t17)

```

```{r}
t17  <- pcr_survey %>%
  group_by(Gender, child_contact_hours ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t17 <- as_grouped_data(x = t17, groups = c("Gender"), columns = NULL)

flextable(t17)

```
Lets create a combined index..groups 7 and 8 have highest prevalence; this is people who have daily or every few day contact for short duration

```{r}

t17  <- pcr_survey %>%
  mutate( intensity_index = if_else(child_contact_hours==3 & child_contact_often==1,1,
                            if_else(child_contact_hours==3 & child_contact_often==2,2,
                            if_else(child_contact_hours==3 & child_contact_often==3,3,
                            if_else(child_contact_hours==2 & child_contact_often==1,4,    
                            if_else(child_contact_hours==2 & child_contact_often==2,5,
                            if_else(child_contact_hours==2 & child_contact_often==3,6,
                            if_else(child_contact_hours==1 & child_contact_often==1,7,
                            if_else(child_contact_hours==1 & child_contact_often==2,8,
                            if_else(child_contact_hours==1 & child_contact_often==3,9,999)))))))))) %>%
  group_by( intensity_index ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

#t17 <- as_grouped_data(x = t17, groups = c("Gender"), columns = NULL)

flextable(t17)
```




Prevalence by sex. Seems that men and women had similar prevalence in Season 1; Women had similar prevalence again in Season 2, men had very little carriage.

```{r}
t16  <- pcr_survey %>%
   group_by( Gender, season ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c("Gender"), columns = NULL)

flextable(t16)
```

Prevalence by sex and child contact (small numbers)

```{r}
t16  <- pcr_survey %>%
  mutate(child_contact_u10 = if_else( (child_contact_u12m==1 |child_contact_13_23m==1 | child_contact_24_59m==1 | child_contact_5_10y==1),1,0   ),
         child_contact_u10= if_else(is.na(child_contact_u12m)| child_contact_u12m==9999,9999,child_contact_u10)) %>%
  group_by( child_contact_u10,Gender ) %>%
  summarize(N=n(), N_pos=sum(piab_pos), Pct_Pos=round(100*mean(piab_pos),1)) 

t16 <- as_grouped_data(x = t16, groups = c('child_contact_u10',"Gender"), columns = NULL)

flextable(t16)

```

    -   Test with Fisher's Exact Test (p\<0.05)

**To be done, as requested by LG**
- Descriptive analysis of NP serotype distribution
		PCV13 serotypes
		PPV23 serotypes
		 NVT seroytpes
- Correlations in serotype positivity among pairs
- Correlations in serotype positivity among pairs over time (i.e., was there a likely transmission event where one adult in the pair was serotype positive and then the second adult in the pair became positive for the same serotype).
- Comparison of genetic lineages for serotypes identified among pairs
- UAD results – how will these be incorporated into the analysis?


### Regression models

Evaluate correlates of pneumococcal positivity.

-   Multivariate logistic regression to identify relevant age groups

```{r, echo=T, eval=F}
        mod1 <- glm(piab_pos ~ child_contact_u12m + child_contact_13_23m + child_contact_24_59m + child_contact_5_10y + child_contact_over10y , family='binomial', data=pcr_survey)

summary(mod1)
```


```{r}
pcr_survey$child_contact_hours <- as.factor(pcr_survey$child_contact_hours)

pcr_survey$child_contact_often <- as.factor(pcr_survey$child_contact_often)

pcr_survey$N_child_contact_1_10 <-  pcr_survey$child_contact_13_23m + pcr_survey$child_contact_24_59m + pcr_survey$child_contact_5_10y
  

   mod1 <- glm(piab_pos ~  child_contact_often  + N_child_contact_1_10  , family='binomial', data=pcr_survey)
summary(mod1)
```

Generalized estimating equation to account for correlation within individuals

```{r, echo=T, eval=F}
mod1.gee <- gee(piab_pos ~ child_contact_u12m+ child_contact_13_23m + child_contact_24_59m + child_contact_5_10y + child_contact_over10y,id=pcr_survey$ID, data=pcr_survey, family=binomial(link='log'), corstr="exchangeable")
```

### Longitudinal data analysis

Use a Markov transition model with 2 states (colonized, uncolonized) to quantify acquisition and clearance rates and correlates of both. The model below estimates acquisition and clearance rates, and teh effect of recent contact with a child \<12m on acquisition rates

```{r, echo=T, eval=F}
mod.df <- pcr_survey %>%
  filter(child_contact_13_23m!=9999 & !is.na(piab_pos)) %>%
  mutate(ID=as.factor(ID))

mod.df$child_contact_u5 <- 
  mod.df$child_contact_u12m + mod.df$child_contact_13_23m + mod.df$child_contact_24_59m

mod.df$child_contact_1_10 <-  mod.df$child_contact_13_23m + mod.df$child_contact_24_59m +
mod.df$child_contact_5_10y


#N contacts
mod.df$child_contact_1_5 <- mod.df$child_contact_13_23m + mod.df$child_contact_24_59m


l1 <- mod.df
l1$day <- 0
l1$day[l1$time==2] <- 14
l1$day[l1$time==3] <- 14*2
l1$day[l1$time==4] <- 14*3
l1$day[l1$time==5] <- 14*4
l1$day[l1$time==6] <- 14*5

l1$state <- NA
l1$state[l1$piab_pos==0 & !is.na(l1$piab_pos)] <- 1
l1$state[l1$piab_pos==1 & !is.na(l1$piab_pos)] <- 2
#l1$state <- as.factor(l1$state)


q1 <- rbind(c( 0,0.01),
           c(0.01,0)
)

l1 <- l1[order(l1$ID, l1$day),]

l2 <- l1[, c('state','child_contact_u5','child_contact_1_5','child_contact','Gender','child_contact_u12m','child_contact_13_23m',"child_contact_24_59m","child_contact_5_10y",'child_contact_over10y','child_contact_1_10', 'ID','day', 'season','child_contact_often','child_contact_hours')]

msm.mod1 <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u12m))
msm.mod1

msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5))
msm.mod1b


msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u5))
msm.mod1b

msm.mod1c <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_10))
msm.mod1c

#clearance rate as a function of child contacts?
msm.mod1e <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list( "2-1" = ~ child_contact_1_10))
msm.mod1e

```

Frequency of child contact and acquisition and clearance rates. Those with contact with children have more frequent acquisition and (apparently) slower clearance. But need to remember that we can't distinguish distinct colonization episodes yet until we get serotype info
```{r}

l2 <- l2%>% 
  mutate(child_contact_often1 =if_else(child_contact_often %in% c('1','2'),1,0),
         child_contact_often2 =if_else(child_contact_often %in% c('3'),1,0))
         
msm.mod1e <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list( "1-2" = ~ child_contact_often1 + child_contact_often2))
msm.mod1e


msm.mod1e <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list( "2-1" = ~ child_contact_often1 + child_contact_often2))
msm.mod1e


```

or hours of contact. acquisition rate is lower for those with 4-8 and 8+ hours of reported contact
```{r}

l2 <- l2%>% 
  mutate(child_contact_hours1 =if_else(child_contact_hours %in% c('1'),1,0),
         child_contact_hours2 =if_else(child_contact_hours %in% c('2','3'),1,0),
         child_contact1_10_dic = if_else(child_contact_1_10>0,1,0))
         
msm.mod1e <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list( "1-2" = ~ child_contact_hours1 + child_contact_hours2))
msm.mod1e
```

It appears those with shorter contacts have higher carriage than those with longer contacts. This could be a) confounding by age of contacts b) some boosting effect from frequent/intense contact

Sems that those with contact with 1-10 year olds with lower duration contact have highest estimate for acquisition rate
```{r}

l2.cat <- l2 %>%
  mutate( child_contact_cat= if_else(child_contact1_10_dic==0 &child_contact_hours1==0 & child_contact_hours2==0,0, 
                             if_else(child_contact1_10_dic==0 & (child_contact_hours1==1 | child_contact_hours2==1),1,
                             if_else(child_contact1_10_dic==1 & child_contact_hours1==1,2,
                            if_else(child_contact1_10_dic==1 & child_contact_hours2==1,3,999)))),
          ) %>%
  filter(child_contact_cat %in% c(0,1,2,3)) %>%
  mutate(child_contact_cat = as.factor(child_contact_cat))

msm.mod1e <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2.cat,covariates = list( "1-2" = ~ child_contact_cat ))
msm.mod1e

#prevalence by category

prop.table(table(l2.cat$child_contact_cat, l2.cat$state),margin=1)

prop.table(table(l2.cat$child_contact_cat, l2.cat$season),margin=2)
```

dichotomized contacts age 1-10y

```{r}

msm.mod1d <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_10_dic))
msm.mod1d
```

Does duration or acquisition rate vary by sex? No.
```{r, eval=F}
q1 <- rbind(c( 0,0.01),
           c(0.01,0)
)
msm.mod2a <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ Gender))
msm.mod2a

msm.mod2b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("2-1" = ~ Gender))
msm.mod2b

#Or season
msm.mod2b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2[l2$Gender=='F',],covariates = list("2-1" = ~ season))
msm.mod2b

# msm.mod2b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ season))
# msm.mod2b
```


Effect of positive household contact. This quantifies transmission within households.

```{r, echo=T, eval=F}
mod.df <- pcr_survey %>%
  filter( !is.na(piab_pos)) %>%
  mutate(ID=as.factor(ID))

recent_hh_col <- mod.df %>%
  group_by(Household,time ) %>%
  summarize(piab_pos=max(piab_pos)) %>%
  mutate(time=time+1) %>%
  rename(piab_pos_HH_prev = piab_pos)

recent_ID_col <- mod.df %>%
  group_by(Household,ID,time ) %>%
  summarize(piab_pos=sum(piab_pos)) %>%
  mutate(time=time+1) %>%
  rename(piab_pos_ID_prev = piab_pos)

#colonized_partner_prev is defined based on a positive household without positive individual on previous time
recent_col <- merge(recent_hh_col,recent_ID_col, by=c('Household', 'time') ) %>%
  mutate(colonized_partner_prev = piab_pos_HH_prev - piab_pos_ID_prev)

mod.df <- merge(mod.df,recent_col, by=c('ID','Household', 'time')) 

#N contacts
mod.df$child_contact_1_10 <- mod.df$child_contact_13_23m + mod.df$child_contact_24_59m  +mod.df$child_contact_5_10y


l1 <- mod.df
l1$day <- 0
l1$day[l1$time==2] <- 14
l1$day[l1$time==3] <- 14*2
l1$day[l1$time==4] <- 14*3
l1$day[l1$time==5] <- 14*4
l1$day[l1$time==6] <- 14*5

l1$state <- NA
l1$state[l1$piab_pos==0 & !is.na(l1$piab_pos)] <- 1
l1$state[l1$piab_pos==1 & !is.na(l1$piab_pos)] <- 2
#l1$state <- as.factor(l1$state)


q1 <- rbind(c( 0,0.01),
           c(0.01,0)
)

l1 <- l1[order(l1$ID, l1$day),]

l2 <- l1[, c('state','Gender','child_contact_1_10', 'ID','day','colonized_partner_prev')]                

table(l2$state, l2$colonized_partner_prev)

msm.mod1 <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ colonized_partner_prev ))

msm.mod1
```

## Notes and challenges

-   The analyses will all be done initially based on piaB positivity. Given the low rate of carriage in adults, this is probably fine to assume that if a person is positive at multiple time points, or multiple people in the household are positive, it is the same serotype. (the former has been confirmed--we have 1 person positive for 15B/C at all time points). Once serotype data are available, we can more precisely define duration and transmission, if there is discordance within individuals or households

-   The evaluations of household transmission are likely underpowered due to low levels of carriage and the fact that when one household member is positive, the other individual is often also positive at the same time point.
