l2$child_1_10[l2$child_contact_13_23m=='Yes' | l2$child_contact_24_59m=='Yes' | l2$child_contact_5_10y=='Yes'] <- 1
l2$child_2_10 <- 0
l2$child_2_10[ l2$child_contact_24_59m=='Yes' | l2$child_contact_5_10y=='Yes'] <- 1
l2$child_5_10 <- 0
l2$child_5_10[  l2$child_contact_5_10y=='Yes'] <- 1
msm.mod1 <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2)
msm.mod1
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact))
msm.mod1b
mod.df$child_contact_u5[mod.df$child_contact_u12m==1 | mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
mod.df$child_contact_u5 <- 0
mod.df$child_contact_u5[mod.df$child_contact_u12m==1 | mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
mod.df <- ds.c %>%
filter(child_contact_13_23m!=9999 & !is.na(piab_pos)) %>%
mutate(ID=as.factor(ID))
mod.df$child_contact_u5 <- 0
mod.df$child_contact_u5[mod.df$child_contact_u12m==1 | mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
l1 <- mod.df
l1$day <- 0
l1$day[l1$time==2] <- 14
l1$day[l1$time==3] <- 14*2
l1$day[l1$time==4] <- 14*3
l1$day[l1$time==5] <- 14*4
l1$day[l1$time==6] <- 14*5
l1$state <- NA
l1$state[l1$piab_pos==0 & !is.na(l1$piab_pos)] <- 1
l1$state[l1$piab_pos==1 & !is.na(l1$piab_pos)] <- 2
#l1$state <- as.factor(l1$state)
q1 <- rbind(c( 0,0.01),
c(0.01,0)
)
l1 <- l1[order(l1$ID, l1$day),]
l2 <- l1[, c('state','child_contact_u5','child_contact','child_contact_u12m','child_contact_13_23m',"child_contact_24_59m","child_contact_5_10y",'child_contact_over10y', 'ID','day')]
msm.mod1 <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2)
msm.mod1
msm.mod1a <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u12m))
msm.mod1a
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u5))
msm.mod1b
mod.df$child_contact_1_5 <- 0
mod.df$child_contact_1_5[ mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5))
mod.df <- ds.c %>%
filter(child_contact_13_23m!=9999 & !is.na(piab_pos)) %>%
mutate(ID=as.factor(ID))
mod.df$child_contact_u5 <- 0
mod.df$child_contact_u5[mod.df$child_contact_u12m==1 | mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
mod.df$child_contact_1_5 <- 0
mod.df$child_contact_1_5[ mod.df$child_contact_13_23m==1 | mod.df$child_contact_24_59m==1] <- 1
l1 <- mod.df
l1$day <- 0
l1$day[l1$time==2] <- 14
l1$day[l1$time==3] <- 14*2
l1$day[l1$time==4] <- 14*3
l1$day[l1$time==5] <- 14*4
l1$day[l1$time==6] <- 14*5
l1$state <- NA
l1$state[l1$piab_pos==0 & !is.na(l1$piab_pos)] <- 1
l1$state[l1$piab_pos==1 & !is.na(l1$piab_pos)] <- 2
#l1$state <- as.factor(l1$state)
q1 <- rbind(c( 0,0.01),
c(0.01,0)
)
l1 <- l1[order(l1$ID, l1$day),]
l2 <- l1[, c('state','child_contact_u5','child_contact_1_5','child_contact','child_contact_u12m','child_contact_13_23m',"child_contact_24_59m","child_contact_5_10y",'child_contact_over10y', 'ID','day')]
msm.mod1 <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2)
msm.mod1
msm.mod1a <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u12m))
msm.mod1a
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_24_59m))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_13_23m))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_13_23m + child_contact_24_59m))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_13_23m ))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5 ))
msm.mod1b
mod.df$child_contact_1_5 <- mod.df$child_contact_13_23m + mod.df$child_contact_24_59m
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5))
msm.mod1b
mod.df$child_contact_u5 <-
mod.df$child_contact_u12m + mod.df$child_contact_13_23m + mod.df$child_contact_24_59m
#N contacts
mod.df$child_contact_1_5 <- mod.df$child_contact_13_23m + mod.df$child_contact_24_59m
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_u5))
msm.mod1b
msm.mod1b <- msm( state~ day ,  subject=ID , qmatrix=q1 , data=l2,covariates = list("1-2" = ~ child_contact_1_5))
msm.mod1b
View(ds.c)
library(readxl)
clean_pcr <- clean_pcr()
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(reshape2)
library(dplyr)
library(stringr)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(ggplotify)
library(table1)
library(lubridate)
library(patchwork)
library(msm)
library(gee)
source('heat.fun.R')
source('heat.fun.contact.R')
source('./R/clean_pcr.R')
source('./R/clean_s1_surveys.R')
source('./R/clean_s2_surveys.R')
clean_pcr <- clean_pcr()
knitr::opts_chunk$set(echo = FALSE)
library(readxl)
library(reshape2)
library(dplyr)
library(stringr)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(ggplotify)
library(table1)
library(lubridate)
library(patchwork)
library(msm)
library(gee)
source('heat.fun.R')
source('heat.fun.contact.R')
source('./R/clean_pcr.R')
source('./R/clean_s1_surveys.R')
source('./R/clean_s2_surveys.R')
clean_pcr <- clean_pcr()
plot(clean_pcr$pcr_summary_long$lyta, clean_pcr$pcr_summary_long$piab, xlim= c(45,0), ylim=c(45,0), xlab='lytA', ylab='piaB', bty='l')
abline(a=0, b=1)
abline(h=40, v=40, col='gray', lty=2)
piab.plot <- heat.fun(target='piab')
# breakslist<-seq(15,45,by=1)
#
# cols1 <- colorRampPalette(c('red4','red','darkorange','orange','gold','lightgoldenrod1','white','white'))(length(breakslist))
#
# p1 <- ggplot(d1.ds, aes(time, HH_order, fill= piab)) +
#   geom_tile() +
#   scale_fill_viridis_c(option = "B", direction = -1) +
#
#   theme_classic()+
#   ylab('Serotype tested')+
#    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   facet_wrap(~Household, ncol=3)+
#   theme(
#   strip.text.x = element_blank()
# )
# p1
lyta.plot <- heat.fun(target='lyta')
c1.m.m <- melt(clean_pcr$pcr_summary[,c('Target','ID','Sample','ct_pos2','Household') ],
id.vars=c('Target','ID','Sample','Household'))
c1.m.c <- dcast(c1.m.m, ID + Household + Sample  ~Target, fun.aggregate = min, fill=999)
#N people
N.id <- length(unique(c1.m.c$ID))
N.id
#N households
N.hh<- length(unique(c1.m.c$Household))
N.hh
#N samples
nrow(c1.m.c)
#length(unique(c1.m.c$Sample[c1.m$Target=='piab']))
#length(unique(c1.m.c$Sample[c1.m$Target=='lyta']))
#N positive
sum(c1.m.c$piab<40 )
sum(c1.m.c$piab<40  &c1.m.c$lyta>=40)
sum(c1.m.c$piab<40  &c1.m.c$lyta<40)
#% positive
sum(c1.m.c$piab<40 )/nrow(c1.m.c)
#N positive lytA
sum(c1.m.c$lyta<40 )
sum(c1.m.c$lyta<40 )/nrow(c1.m.c)
#Count N people with piaB positives by IDs
c1.m.spl.id <- split(c1.m.c, c1.m.c$ID)
N_pos_people <- sum(sapply(c1.m.spl.id, function(x){
min(x$piab) <40
}
))
N_pos_people
N_pos_people/N.id
#Count N HH with piab positives by IDs
c1.m.spl.id <- split(c1.m.c, c1.m.c$Household)
n_pos_hh <- sum(sapply(c1.m.spl.id, function(x){
min(x$piab) <40
}
))
n_pos_hh
n_pos_hh/N.hh
# ## Ave age
# age1 <- read_excel('./Data/confidential/AGE Scope Participants samples pick-up 06-15-2021.xlsx', skip=1)
# names(age1)[1] <- 'ID'
# age1 <- age1[ which(age1$ID %in% unique(c1.m.c$ID)),]
# mean(age1$AGE)
# range(age1$AGE)
s1_data <- clean_s1_surveys()
d1.ds <- readRDS( './Data/PCR_compiled.rds')
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2')
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
names(s2_demographics_a)
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx')
names(s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx')
)
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
names(s2_demographics_b)
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(ID= `season 1 scope ID`)
names(s1_demographics)
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID)
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID")
str(s1_demographics)
str(s2_demographics_b)
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID) %>%
mutate(`season 1 scope ID`=as.numeric(`season 1 scope ID`))
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID")
View(s2_demographics_b2)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2')
str(s2_demographics_a)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`)
names(s2_demographics_b2)
names(s2_demographics_a)
str(s2_demographics_b)
str(s1_demographics)
View(s1_demographics)
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID) %>%
mutate(`season 1 scope ID`=as.numeric(`season 1 scope ID`))
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID") %>%
rename(ID=`season 2 scope ID`) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`)
names(s2_demographics_a)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
)
names(s2_demographics_a)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
)
str(s2_demographics_a)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
) %>%
mutate(Age = lubridate::time_length(difftime(as.Date('2022-01-01'), dob), "years") )
View(s2_demographics_a)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
) %>%
mutate(Age = lubridate::time_length(difftime(as.Date('2022-01-01'), dob), "years") ) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b)
View(s2_demographics)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2)
s2_surv <- read.csv('./Data/confidential/Season_2_Surveys/Uptodat Fortnightly_Wyllie_DATA_2022-07-21_1314 .csv') %>%
rename(scope_id=participant_id,
child_contact=child_contact_2weeks,
child_contact_u12m=child_contact_age___1,
child_contact_13_23m=child_contact_age___2,
child_contact_24_59m=child_contact_age___3,
child_contact_5_10y=child_contact_age___4,
child_contact_over10y=child_contact_age___5,
activity_community_center=activities_describe___1,
activity_friends=activities_describe___2,
activity_family=activities_describe___3,
acitivity_fitness=activities_describe___4,
activity_other=activities_describe___5
) %>%
mutate(ID = paste0('S2_',gsub("\\..*","",scope_id)) , time=visit_number)
table(s2_surv$visit_number)
d1.ds <- readRDS( './Data/PCR_compiled.rds')
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID) %>%
mutate(`season 1 scope ID`=as.numeric(`season 1 scope ID`))
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID") %>%
rename(ID=`season 2 scope ID`) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
) %>%
mutate(Age = lubridate::time_length(difftime(as.Date('2022-01-01'), dob), "years") ) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2)
s2_pcr <- d1.ds[grep('S2', d1.ds$ID),]
s2_a <- merge(s2_pcr, s2_surv, by=c('ID','time'), all=T) %>%
mutate(piab_pos = 1*(piab<40))
N_surveys <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = length)
s2_a <- s2_a %>%
filter(!is.na(time))
s2_a$child_contact[is.na(s2_a$child_contact)] <- 9999
s2_a$child_contact[is.infinite(s2_a$child_contact)] <- 9999
s2_a$child_contact_u12m[is.na(s2_a$child_contact_u12m)] <-9999
s2_a$child_contact_13_23m[is.na(s2_a$child_contact_13_23m)] <-9999
s2_a$child_contact_24_59m[is.na(s2_a$child_contact_24_59m)] <-9999
s2_a$child_contact_5_10y[is.na(s2_a$child_contact_5_10y)] <-9999
s2_a$child_contact_over10y[is.na(s2_a$child_contact_over10y)] <-9999
str(s2_a)
View(s2_a)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2) %>%
mutate(ID= paste0('ID_',ID))
View(s2_demographics)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2) %>%
mutate(ID= paste0('S2_',ID))
s2_pcr <- d1.ds[grep('S2', d1.ds$ID),]
s2_a <- merge(s2_pcr, s2_surv, by=c('ID','time'), all=T) %>%
mutate(piab_pos = 1*(piab<40))
View(s2_pcr)
View(s2_surv)
s2_a <- merge(s2_a,s2_demographics, by='ID')
s2_a <- merge(s2_a,s2_demographics, by='ID', all=T)
N_contacts <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = max, na.rm=T, fill=9999)
rename(scope_id=participant_id,
child_contact=child_contact_2weeks,
child_contact_u12m=child_contact_age___1,
child_contact_13_23m=child_contact_age___2,
child_contact_24_59m=child_contact_age___3,
child_contact_5_10y=child_contact_age___4,
child_contact_over10y=child_contact_age___5,
activity_community_center=activities_describe___1,
activity_friends=activities_describe___2,
activity_family=activities_describe___3,
acitivity_fitness=activities_describe___4,
activity_other=activities_describe___5
) %>%
mutate(ID = paste0('S2_',gsub("\\..*","",scope_id)) , time=visit_number)
table(s2_surv$visit_number)
d1.ds <- readRDS( './Data/PCR_compiled.rds')
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID) %>%
mutate(`season 1 scope ID`=as.numeric(`season 1 scope ID`))
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID") %>%
rename(ID=`season 2 scope ID`) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
) %>%
mutate(Age = lubridate::time_length(difftime(as.Date('2022-01-01'), dob), "years") ) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2) %>%
mutate(ID= paste0('S2_',ID))
s2_pcr <- d1.ds[grep('S2', d1.ds$ID),]
s2_a <- merge(s2_pcr, s2_surv, by=c('ID','time'), all=T) %>%
mutate(piab_pos = 1*(piab<40))
N_surveys <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = length)
s2_a <- s2_a %>%
filter(!is.na(time))
s2_a$child_contact[is.na(s2_a$child_contact)] <- 9999
s2_a$child_contact[is.infinite(s2_a$child_contact)] <- 9999
s2_a$child_contact_u12m[is.na(s2_a$child_contact_u12m)] <-9999
s2_a$child_contact_13_23m[is.na(s2_a$child_contact_13_23m)] <-9999
s2_a$child_contact_24_59m[is.na(s2_a$child_contact_24_59m)] <-9999
s2_a$child_contact_5_10y[is.na(s2_a$child_contact_5_10y)] <-9999
s2_a$child_contact_over10y[is.na(s2_a$child_contact_over10y)] <-9999
s2_a <- merge(s2_a,s2_demographics, by='ID', all=T)
N_contacts <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = max, na.rm=T, fill=9999)
s1_data <- clean_s1_surveys()
s2_data <- clean_s2_surveys()
s1 <- s1_data$survey_and_pcr_s1 %>%
select(ID, time, Household, lyta, piab,activities, activity_family, activity_friends, activity_community_center, acitivity_fitness,child_contact,child_contact_u12m,child_contact_13_23m,child_contact_24_59m ,child_contact_5_10y,child_contact_over10y )
s2 <- s2_data$survey_and_pcr_s2  %>%
select(ID, time, Household, lyta, piab,activities, activity_family, activity_friends, activity_community_center, acitivity_fitness,child_contact, child_contact_u12m,child_contact_13_23m,child_contact_24_59m ,child_contact_5_10y,child_contact_over10y )
ds.c <- bind_rows(s1, s2) %>%
mutate(season= str_extract(ID, "[^_]+"),
piab_pos=1*(ds.c$piab<45))
s1 <- s1_data$survey_and_pcr_s1 %>%
select(ID, time, Household, lyta, piab,activities, activity_family, activity_friends, activity_community_center, acitivity_fitness,child_contact,child_contact_u12m,child_contact_13_23m,child_contact_24_59m ,child_contact_5_10y,child_contact_over10y )
ds.c <- bind_rows(s1, s2) %>%
mutate(season= str_extract(ID, "[^_]+"),
piab_pos=1*(ds.c$piab<45))
ds.c <- bind_rows(s1, s2)
ds.c <- bind_rows(s1, s2) %>%
mutate(season= str_extract(ID, "[^_]+"),
piab_pos=1*(piab<45))
ds.c %>%
group_by(season) %>%
summarize(prevalence= mean(piab_pos, na.rm=T), N_pos=sum(piab_pos, na.rm=T), n_test=n())
table(ds.c$piab_pos, ds.c$Gender)
names(s2_data$survey_and_pcr_s2)
s2_data$survey_and_pcr_s2$gennames(s2_demographics)
names(s2_demographics)
names(s2_a)
##Clean S2 surveys
library(dplyr)
clean_s2_surveys <- function(){
s2_surv <- read.csv('./Data/confidential/Season_2_Surveys/Uptodat Fortnightly_Wyllie_DATA_2022-07-21_1314 .csv') %>%
rename(scope_id=participant_id,
child_contact=child_contact_2weeks,
child_contact_u12m=child_contact_age___1,
child_contact_13_23m=child_contact_age___2,
child_contact_24_59m=child_contact_age___3,
child_contact_5_10y=child_contact_age___4,
child_contact_over10y=child_contact_age___5,
activity_community_center=activities_describe___1,
activity_friends=activities_describe___2,
activity_family=activities_describe___3,
acitivity_fitness=activities_describe___4,
activity_other=activities_describe___5
) %>%
mutate(ID = paste0('S2_',gsub("\\..*","",scope_id)) , time=visit_number)
table(s2_surv$visit_number)
d1.ds <- readRDS( './Data/PCR_compiled.rds')
s1_demographics <- read_excel('./Data/scope_demographics deidentified S1.xlsx') %>%
rename(`season 1 scope ID`=ID) %>%
mutate(`season 1 scope ID`=as.numeric(`season 1 scope ID`))
s2_demographics_b <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='repeat participant cheat sheet')
s2_demographics_b2 <- left_join(s2_demographics_b,s1_demographics, by="season 1 scope ID") %>%
rename(ID=`season 2 scope ID`) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics_a <- read_excel('./Data/confidential/New Participants SCOPE_season 2.xlsx', sheet='new participants season 2') %>%
rename(ID = `scope ID`, Race = `How would you describe your ethnicity?`,
Ethnicity = `Would you consider yourself Hispanic or Non-Hispanic?`,
dob= `What is your date of birth?`
) %>%
mutate(Age = lubridate::time_length(difftime(as.Date('2022-01-01'), dob), "years") ) %>%
select(ID, Age, Gender, Race, Ethnicity)
s2_demographics <- bind_rows(s2_demographics_a, s2_demographics_b2) %>%
mutate(ID= paste0('S2_',ID))
s2_pcr <- d1.ds[grep('S2', d1.ds$ID),]
s2_a <- merge(s2_pcr, s2_surv, by=c('ID','time'), all=T) %>%
mutate(piab_pos = 1*(piab<40))
N_surveys <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = length)
s2_a <- s2_a %>%
filter(!is.na(time))
s2_a$child_contact[is.na(s2_a$child_contact)] <- 9999
s2_a$child_contact[is.infinite(s2_a$child_contact)] <- 9999
s2_a$child_contact_u12m[is.na(s2_a$child_contact_u12m)] <-9999
s2_a$child_contact_13_23m[is.na(s2_a$child_contact_13_23m)] <-9999
s2_a$child_contact_24_59m[is.na(s2_a$child_contact_24_59m)] <-9999
s2_a$child_contact_5_10y[is.na(s2_a$child_contact_5_10y)] <-9999
s2_a$child_contact_over10y[is.na(s2_a$child_contact_over10y)] <-9999
s2_a <- merge(s2_a,s2_demographics, by='ID', all=T)
N_contacts <- dcast(s2_a[c('ID','time','child_contact')], ID~time, fun.aggregate = max, na.rm=T, fill=9999)
out.list <- list('survey_and_pcr_s2'=s2_a,'contacts_wide_s2'=N_contacts)
return(out.list)
}
s2_data <- clean_s2_surveys()
names(s2_data)
names(s2_data$survey_and_pcr_s2)
s1 <- s1_data$survey_and_pcr_s1 %>%
select(ID, time, Household, lyta, piab,activities, activity_family, activity_friends, activity_community_center, acitivity_fitness,child_contact,child_contact_u12m,child_contact_13_23m,child_contact_24_59m ,child_contact_5_10y,child_contact_over10y , Age, Gender, Race, Ethnicity)
s2 <- s2_data$survey_and_pcr_s2  %>%
select(ID, time, Household, lyta, piab,activities, activity_family, activity_friends, activity_community_center, acitivity_fitness,child_contact, child_contact_u12m,child_contact_13_23m,child_contact_24_59m ,child_contact_5_10y,child_contact_over10y,, Age, Gender, Race, Ethnicity )
ds.c <- bind_rows(s1, s2) %>%
mutate(season= str_extract(ID, "[^_]+"),
piab_pos=1*(piab<45))
table(ds.c$piab_pos, ds.c$Gender)
str(ds.c$Gender)
if_else(Gender %in% c('Male','M'), 'M', NA))
ds.c < ds.c %>%
mutate(if_else(Gender %in% c('Female','F'), 'F',
if_else(Gender %in% c('Male','M'), 'M', NA)))
ds.c < ds.c %>%
mutate(if_else(Gender %in% c('Female','F'), 'F',
if_else(Gender %in% c('Male','M'), 'M', NA_character_)))
ds.c$Gender[ds.c$Gender=='Female'] <- 'F'
ds.c$Gender[ds.c$Gender=='Male'] <- 'M'
table(ds.c$piab_pos, ds.c$Gender)
ds.c %>%
filter(piab_pos==1) %>%
group_by(Gender) %>%
summarize(mean_ct=mean(piab))
piab_men <- ds.c %>%
filter(piab_pos==1 & Gender=='M')
piab_women <- ds.c %>%
filter(piab_pos==1 & Gender=='F')
wilcox.test(piab_women$piab, piab_men$piab, alternative = "two.sided")
View(piab_women)
ds.c %>%
filter(piab_pos==1) %>%
group_by(Gender) %>%
summarize(mean_ct=mean(piab))
ds.c %>%
filter(piab_pos==1) %>%
ggplot( aes(x=Gender,y=piab)) +
geom_violin()+ theme_classic()
library(ggplot2)
ds.c %>%
filter(piab_pos==1) %>%
ggplot( aes(x=Gender,y=piab)) +
geom_violin()+ theme_classic()
table(ds.c$g)
table(ds.c$Gender)
?table
table(ds.c$Gender, useNA='always')
