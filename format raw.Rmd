---
title: "format_data"
author: "Dan Weinberger"
date: "5/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(reshape2)
library(dplyr)
library(stringr)

library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(ggplotify)
library(patchwork)
source('heat.fun.R')

```


ID 6.1 Saliva was very low under 100 ul.

ID 5.6 qpcr LytA -piaB was ran in plate A155_scope_2021_06_02 .The issue was the label: FIXED 5.5 to 5.6

ID 12.4 qPCR LytA -piaB was ran in plate A150_scope_2021_05_24.The issue was the label --FIXED 12.3 to 12.4

ID 62.2,63.2 samples were picked up 1 month after .We didnâ€™t see any growth after incubation 37 degree over night 

ID 20.5 - 21.5 to verify


```{r}
 key1 <- read.csv('./Data/hh_id_key.csv')
master1 <- read_excel('./Data/confidential/SCOPE_Master_20210108.xlsx', sheet='COM SAL')
q1 <- read_excel('./Data/confidential/SCOPE Fortnightly Questionnaire_July 16, 2021_12.45.xlsx')
key2 <- read_excel('./Data/confidential/SCOPE Participant MRN and ID.xlsx', skip=1)
# file.test <- list(
#   "A143_scope_2021_05_11.xlsx",
#   "A144_scope_2021_05_12_DC.xlsx",
#   "A145_scope_2021-05-04_DC.xlsx", #LABELING??
#   "A146_scope_2021_05_17.xlsx",
#   "A146_scope_2021_06_03 lyta_DC.xlsx",
#    #"A147-A148_2021_05_24_DC.xlsx",#?? NO SAMPLE LABELS; QUALITY?
#   "A147_scope_2021_05_17.xlsx",  #??
#   "A147_scope_2021_05_26_repeatnewlytaprobe_DC.xlsx", #??
#   "A148_scope_2021_05_19.xlsx",
#   "A148_scope_2021_05_27_repeatedwithnewlytaprobe_DC.xlsx",
#   "A149_scope_2021_05_19.xlsx",  #??
#   "A149_scope_2021_06_09_lytarepeat_DC.pltd.xlsx",  #??
#   'A149_scope_2021_06_08_lyta.pltd.xlsx',  #??
#   'A150_scope_2021_05_24_DC.xlsx',
#   'A151_scope_2021_05_29 repeat lyta_DC.xlsx',
#   'A153_scope_2021_05_29_DC.xlsx',
#   'A154_2021_-06_02_DC.xlsx',
#   'A155_2021_06_02_DC.xlsx',
#   'A156_scope_2021_06_03_DC.xlsx',
#  # 'A157_SCOPE_2021_06_07_AT.xlsx',#??
#   'A157_scope_2021_06_08 lyta-piaB repeat_DC.xlsx' #??
# )

file_list <- list.files(path="./Data/cleaned")
  
 all.res <-
   lapply(file_list, function(x){
     print(x)
     ds <- read_excel(paste0("./Data/cleaned/",x), skip=19)
     ds$expt <- substr(x,1,4)
     ds$Sample <- as.character(ds$Sample)
     ds$Target <- as.character(ds$Target)
     ds$Cq <- as.numeric(as.character(ds$Cq))
     cols.keep <- 
       c('Cq','Sample','Target','Content','expt','Biological Set Name')
     ds.names <- names(ds)
     ds.names <- intersect(ds.names,cols.keep)
    ds <- ds[,ds.names]
     return(ds)
   })
 

all.res <- lapply(1:length(all.res), function(x){ all.res[[x]]$plate= x 
return(all.res[[x]])
}) 


test1 <- lapply(all.res, function(x)  is.character(x$Target))

b1 <- bind_rows(all.res) 

b1$Target[is.na(b1$Target)] <- 
  b1$`Biological Set Name`[is.na(b1$Target)]

b1 <- b1[b1$Content!='Std',]

b1$Target <- gsub(' ' ,'', b1$Target, fixed=T)

b1$Target <- tolower(b1$Target)

#b1$Sample[is.na(b1$Sample)] <- b1$`sample id`[is.na(b1$Sample)]

b1 <-b1[!is.na(b1$Sample),]

b1$Sample <- round(as.numeric(b1$Sample),1)

b1 <- b1[b1$Sample>0 & !is.na(b1$Sample),]

c1 <- b1[, c('Sample','Cq','Target','plate')]

c1$Cq[is.na(c1$Cq)] <- 45

c1.m <- reshape2::melt(c1, id.vars= c('Sample','Target','plate'))

c1.c <- reshape2::dcast(c1.m, Sample+plate +variable ~ Target, fun.aggregate = min)

c1.c$pos <- c1.c$lyta<40 & c1.c$piab<40

write.csv(c1.c, './Data/cleaned_file.csv')



```

```{r, fig.width=5, fig.height=5}
plot(c1.c$lyta, c1.c$piab, xlim= c(45,0), ylim=c(45,0), xlab='lytA', ylab='piaB', bty='l')
abline(a=0, b=1)
abline(h=40, v=40, col='gray', lty=2)
```


```{r}

c1.m$ID <- sub("\\.[0-9]+$", "", c1.m$Sample)
c1.m$ID <- as.numeric(as.character(c1.m$ID))
c1.m$time <- sub('.*\\.', '', c1.m$Sample)

c1.m <- c1.m[order(c1.m$ID, c1.m$time),]
c1.m <- merge(c1.m, key1, by.x='ID',by.y='id')

d1 <- dcast(c1.m[,c('ID','Target','time','value')],  ID +Target ~ time, fun.aggregate = min, na.rm=T)

write.csv(d1, './Data/Result1.csv')

d1.alt <- dcast(c1.m[,c('ID','Target','time','value')],  ID +time~ Target, fun.aggregate = min, na.rm=T)

write.csv(d1.alt, './Data/Result2.csv') #Anne's preferred format


d1.a <- acast(c1.m[,c('ID','Target','time','value','Household')], Target ~ ID +Household ~ time, fun.aggregate=min, na.rm=T, fill=9999)


```

## Heatmaps
```{r, fig.width=4, fig.height=8}
piab.plot <- heat.fun(target='piab')
lyta.plot <- heat.fun(target='lyta')

```

## Merge in results with master file

```{r}
ilogit <- function(x){
  exp(x)/(1+exp(x))
}
master1$merge_id <- as.numeric(as.character(gsub('CS00','',master1$dw_id_full)))

e1 <- merge(c1.c, master1, by.x='Sample', by.y='merge_id', all.x)

e1$pos <- 1*(e1$piab<40)

e1$sample_Date <- as.Date(as.numeric(e1$`sample date`), origin=as.Date('1899-12-30')) #use excel origin of 12-30-1899
hist(e1$sample_Date, breaks=10)
e1$part_id <- as.numeric(e1$number)

e2 <- merge(e1, key2, by.x='part_id', by.y="ID Number", all=T)
e2$`MR#` <- as.numeric(gsub("MR","", e2$`MR#`  ))

q1$MRN <-  gsub("_visit#2.pdf","", q1$MRN )
q1$MRN <-  as.numeric(gsub("MR","", q1$MRN ))

q1$visitN <- as.numeric(as.character(substring(q1$`Fortnightly visit number:`,2)))

e3 <- merge(e2, q1, by.x=c('MR#','timeline'), by.y=c('MRN','visitN'), all=T)  

e3$`What sorts of activities have you participated in? - Selected Choice`[e3$`Have you taken part in any social activities or outings during the past two weeks?`=='No'] <- 'none'
```

```{r}
table(e3$pos, e3$`Have you had any contact with children in the past two weeks?`)
```

```{r}
table(e3$pos, e3$`How often do you usually have contact with children?`)
```

```{r}
table(e3$pos, e3$`How much contact per day do you have?`)
```

```{r}
table(e3$pos, e3$`If yes, what is the age range of the children you have had contact with? - Selected Choice`)
```

Need to fix this so that those not doing activities also represented
```{r}
table(e3$pos, e3$`Have you taken part in any social activities or outings during the past two weeks?`)
```

```{r}
table(e3$pos, e3$`What sorts of activities have you participated in? - Selected Choice`)
```

```{r}
table(e3$pos, e3$`Have you had any of the following symptoms in the past two weeks? - Q12#1 - Nasal congestion`)
table(e3$pos, e3$`Have you had any of the following symptoms in the past two weeks? - Q12#1 - Coughing`)
table(e3$pos, e3$`Have you had any of the following symptoms in the past two weeks? - Q12#1 - Running nose`)
```

```{r}
table(e3$pos, e3$`Which symptoms are you experiencing today? - Q13#1 - Coughing`)
table(e3$pos, e3$`Which symptoms are you experiencing today? - Q13#1 - Running nose`)
table(e3$pos, e3$`Which symptoms are you experiencing today? - Q13#1 - Sore throat`)
```


```{r}
mod1 <- mgcv::gam(pos ~s(as.numeric(sample_Date)), family='binomial', data=e1, method='REML')


#mod1 <- mgcv::gam(pos ~s(as.numeric(sample_Date)), family='binomial', data=e1 )


plot(mod1)


pred1 <- predict(mod1)
plot(ilogit(pred1), ylim=c(0,0.2))
```













